<!doctype html>
<meta charset="utf-8" />
<title>GitHub Save — translation.json</title>

<!-- Visible UI (token + status + Save button) -->
<label for="pat" style="display:block;margin:8px 0 4px;">Personal Access Token</label>
<input id="pat" type="password" placeholder="ghp_..." style="width:420px;max-width:100%;" />
<button id="saveBtn" style="margin-left:8px;">Save to GitHub</button>
<div id="status" style="margin-top:10px;font-family:sans-serif;"></div>

<script>
/* ========= Fixed repo/branch/path (not shown in UI) ========= */
const GH_OWNER  = 'johanpantzare';
const GH_REPO   = 'video-course';
const GH_BRANCH = 'master';
const GH_PATH   = 'translation.json';

/* ========= Small status helper ========= */
function setStatus(msg){ document.getElementById('status').textContent = msg; }

/* ========= Base64 (Unicode-safe) ========= */
function toB64(str){ return btoa(unescape(encodeURIComponent(str))); }

/* ========= Get current file SHA (or '' if it doesn't exist) ========= */
async function fetchSha(headers){
  const url = `https://api.github.com/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${encodeURIComponent(GH_PATH)}?ref=${encodeURIComponent(GH_BRANCH)}`;
  const res = await fetch(url, { headers });
  if(res.status === 404) return ''; // new file
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`Pre-save sha fetch failed (${res.status}): ${t || res.statusText}`);
  }
  const data = await res.json();
  return data.sha || '';
}

/* ========= PUT (create/update) once ========= */
async function putOnce(headers, contentText, sha){
  const body = {
    message: 'Update translation.json',
    content: toB64(contentText),
    branch: GH_BRANCH,
    ...(sha ? { sha } : {})
  };
  const url = `https://api.github.com/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${encodeURIComponent(GH_PATH)}`;
  const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(body) });
  if(!res.ok){
    const errTxt = await res.text().catch(()=> '');
    let msg = errTxt || res.statusText;
    try { msg = JSON.parse(errTxt).message || msg; } catch {}
    if(res.status === 401) throw new Error(`401 Unauthorized: invalid/missing token or missing scope (public_repo / repo). ${msg}`);
    if(res.status === 403) throw new Error(`403 Forbidden: branch protection or insufficient token scope. ${msg}`);
    if(res.status === 409) throw new Error(`409 Conflict: SHA out-of-date. ${msg}`);
    throw new Error(`${res.status} ${res.statusText}: ${msg}`);
  }
  return res.json();
}

/* ========= Main save ========= */
async function githubSave(){
  setStatus('Saving to GitHub…');

  // Require LESSON from your page/app
  if(typeof window.LESSON === 'undefined'){
    setStatus('Load JSON first.');
    return;
  }

  // Only visible input: PAT
  const token = (document.getElementById('pat').value || '').trim();
  if(!token){
    setStatus('Please paste your Personal Access Token.');
    return;
  }

  // Prepare payload (pretty JSON)
  const json = JSON.stringify(window.LESSON, null, 2);

  // Headers
  const headers = {
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version': '2022-11-28',
    'Content-Type': 'application/json',
    'Authorization': `token ${token}`
  };

  try{
    const latestSha = await fetchSha(headers);
    try{
      await putOnce(headers, json, latestSha);
      setStatus('Saved ✔');
    }catch(e){
      if(String(e.message).includes('409')){ // retry once on conflict
        const freshSha = await fetchSha(headers);
        await putOnce(headers, json, freshSha);
        setStatus('Saved after retry ✔');
      }else{
        setStatus('Save failed: ' + e.message);
      }
    }
  }catch(e){
    setStatus('Save error: ' + e.message);
  }
}

/* ========= Wire up ========= */
document.getElementById('saveBtn').addEventListener('click', githubSave);
</script>
