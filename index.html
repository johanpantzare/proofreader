<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lesson JSON Translation Editor</title>
  <style>
    :root{
      --brand:#081A35;--muted:#6b7280;--ok:#16a34a;--warn:#e11d48;--line:#e5e7eb;
    }
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial,sans-serif;background:#f5f7fb;color:#0f172a}
    header{padding:16px 20px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    header h1{font-size:18px;margin:0 0 4px 0;color:var(--brand)}
    header .sub{color:var(--muted);font-size:13px}

    .container{max-width:1200px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .toolbar > * {flex:0 0 auto}
    select, input[type="text"], textarea, button{
      border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font:inherit
    }
    button{cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:transparent}
    button.ghost{background:#fff}
    label.chk{display:flex;gap:8px;align-items:center;font-size:13px;color:#334155}

    details.config{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:12px}
    details.config summary{cursor:pointer;font-weight:600}
    textarea#jsonInput{width:100%;min-height:160px;font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace}

    .status{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid var(--line);background:#fff}

    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:64px;background:#f9fafb;border-bottom:1px solid var(--line);font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:#334155;padding:8px}
    tbody td{border-bottom:1px solid var(--line);vertical-align:top;padding:8px}
    tbody tr:nth-child(odd){background:#fcfdff}
    .path{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:nowrap;max-width:340px;overflow:hidden;text-overflow:ellipsis}
    .base, .loc{min-width:260px}
    textarea.edit{width:100%;min-height:60px;resize:vertical;font-family:inherit}
    .len{color:#475569;font-size:12px}
    .missing{color:var(--warn);font-weight:600}
    .ok{color:var(--ok);font-weight:600}

    .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .counter{font-size:12px;color:#334155}
  </style>
</head>
<body>
  <header>
    <h1>Lesson JSON Translation Editor</h1>
    <div class="sub">Paste your <code>lessonData</code> JSON and let proofreaders edit strings per language. Exports the updated JSON.</div>
  </header>

  <div class="container">
    <details class="config" open>
      <summary>Load / Paste JSON</summary>
      <div style="display:grid;gap:8px">
        <div class="status">Tip: If this page is embedded where <code>window.lessonData</code> already exists, click “Load from window.lessonData”. Otherwise paste the raw JSON below and click “Load JSON”.</div>
        <div class="toolbar">
          <button id="btnLoadWindow" class="ghost">Load from <code>window.lessonData</code></button>
          <button id="btnLoadTextarea" class="primary">Load JSON</button>
          <button id="btnDownload" class="ghost">Export Updated JSON</button>
          <button id="btnCSV" class="ghost">Export CSV (visible)</button>
        </div>
        <textarea id="jsonInput" placeholder='Paste the JSON for your lesson here (either the object itself or {"lessonData": ...}).'></textarea>
      </div>
    </details>

    <div class="toolbar">
      <label>Locale
        <select id="localeSelect"></select>
      </label>
      <label>Base (comparison)
        <select id="baseSelect"></select>
      </label>
      <input id="search" type="text" placeholder="Search in path or text…" />
      <label class="chk"><input type="checkbox" id="missingOnly"/> Show missing/empty only</label>
      <label class="chk"><input type="checkbox" id="ensureKeys"/> Ensure keys exist for selected locale when exporting</label>
      <span id="counts" class="counter">—</span>
    </div>

    <table id="grid" hidden>
      <thead>
        <tr>
          <th style="width:36px">#</th>
          <th>Path</th>
          <th>Base</th>
          <th>Locale</th>
          <th style="width:120px">Len</th>
          <th style="width:100px">Status</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
      <span class="counter" id="footerCounts">—</span>
    </div>
  </div>

<script>
(() => {
  // ————— Utilities —————
  const isLocaleKey = (k) => k === 'basic' || /^[a-z]{2}_[A-Z]{2}$/.test(k);
  const by = (k) => (a,b) => (a[k] > b[k]) ? 1 : (a[k] < b[k]) ? -1 : 0;

  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
    a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function downloadCSV(filename, rows){
    const esc = (s) => '"' + (String(s??'').replaceAll('"','""')) + '"';
    const header = ['#','path','baseLocale','base','locale','value'].map(esc).join(',');
    const lines = rows.map(r => [r.idx, r.path, r.baseLocale, r.base, r.locale, r.value].map(esc).join(','));
    const csv = [header, ...lines].join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ————— State —————
  let LESSON = null;             // the full JSON object
  let RECORDS = [];              // flat list of translatable entries
  let LOCALES = new Set();       // discovered locales

  // ————— Discovery —————
  function collectLocales(obj){
    // 1) from lesson.languages if available
    try{
      (obj.languages||[]).forEach(x => x?.locale && LOCALES.add(x.locale));
    }catch{}
    // 2) from any translatable object keys
    traverse(obj, (node) => {
      if (node && typeof node === 'object' && !Array.isArray(node)){
        const keys = Object.keys(node);
        if (keys.some(isLocaleKey)){
          keys.filter(isLocaleKey).forEach(k => LOCALES.add(k));
        }
      }
    });
  }

  function traverse(obj, cb, path = ''){
    cb(obj, path);
    if (Array.isArray(obj)){
      obj.forEach((v,i) => traverse(v, cb, path + '[' + i + ']'));
    } else if (obj && typeof obj === 'object'){
      for (const [k,v] of Object.entries(obj)){
        traverse(v, cb, path + (path?'.':'') + k);
      }
    }
  }

  function collectTranslatables(obj){
    const recs = [];
    traverse(obj, (node, path) => {
      if (!node || typeof node !== 'object' || Array.isArray(node)) return;
      const keys = Object.keys(node);
      if (!keys.some(isLocaleKey)) return;
      // It's a translatable bundle
      const locales = keys.filter(isLocaleKey);
      const baseLocale = locales.includes('en_US') ? 'en_US' : (locales.includes('basic') ? 'basic' : locales[0]);
      recs.push({ path, node, baseLocale });
    });
    return recs;
  }

  // ————— Rendering —————
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const tbody = $('#tbody');
  const grid = $('#grid');

  function renderTable(){
    const locale = $('#localeSelect').value;
    const base = $('#baseSelect').value;
    const q = $('#search').value.trim().toLowerCase();
    const missingOnly = $('#missingOnly').checked;

    tbody.innerHTML = '';
    let idx = 0, shown = 0, missing = 0;
    const rowsForCSV = [];

    for (const rec of RECORDS){
      idx++;
      const baseText = rec.node?.[base] ?? '';
      const locText = rec.node?.[locale] ?? '';

      const isMissing = (locText ?? '') === '';
      if (isMissing) missing++;

      const hay = (rec.path + ' ' + baseText + ' ' + locText).toLowerCase();
      if (q && !hay.includes(q)) continue;
      if (missingOnly && !isMissing) continue;

      shown++;

      const tr = document.createElement('tr');
      const tdIdx = document.createElement('td'); tdIdx.textContent = String(idx); tr.appendChild(tdIdx);

      const tdPath = document.createElement('td'); tdPath.className = 'path'; tdPath.title = rec.path; tdPath.textContent = rec.path; tr.appendChild(tdPath);

      const tdBase = document.createElement('td'); tdBase.className = 'base';
      const baseArea = document.createElement('div'); baseArea.textContent = baseText; tdBase.appendChild(baseArea); tr.appendChild(tdBase);

      const tdLoc = document.createElement('td'); tdLoc.className = 'loc';
      const ta = document.createElement('textarea');
      ta.className = 'edit'; ta.value = locText ?? '';
      ta.addEventListener('input', (e) => {
        rec.node[locale] = e.target.value; // bind live
        updateCounts();
      });
      tdLoc.appendChild(ta); tr.appendChild(tdLoc);

      const tdLen = document.createElement('td'); tdLen.innerHTML = `<span class="len">${(ta.value||'').length}</span>`; tr.appendChild(tdLen);
      ta.addEventListener('input', () => tdLen.innerHTML = `<span class="len">${(ta.value||'').length}</span>`);

      const tdStatus = document.createElement('td');
      tdStatus.innerHTML = isMissing ? `<span class="missing">Missing</span>` : `<span class="ok">OK</span>`;
      ta.addEventListener('input', () => tdStatus.innerHTML = (ta.value.trim()==='')?`<span class="missing">Missing</span>`:`<span class="ok">OK</span>`);
      tr.appendChild(tdStatus);

      tbody.appendChild(tr);

      rowsForCSV.push({ idx, path: rec.path, baseLocale: base, base: baseText, locale, value: ta.value });
    }

    grid.hidden = false;
    $('#counts').textContent = `${shown} rows · ${missing} missing`;
    $('#footerCounts').textContent = `${RECORDS.length} total translatable bundles · showing ${shown} rows`;

    // Store for CSV export of visible state
    grid.dataset.csv = JSON.stringify(rowsForCSV);
  }

  function populateLocaleSelects(){
    const locs = Array.from(LOCALES).sort();
    const sel = $('#localeSelect');
    const baseSel = $('#baseSelect');
    sel.innerHTML = '';
    baseSel.innerHTML = '';
    for (const l of locs){
      const o1 = document.createElement('option'); o1.value = l; o1.textContent = l; sel.appendChild(o1);
      const o2 = document.createElement('option'); o2.value = l; o2.textContent = l; baseSel.appendChild(o2);
    }
    // sensible defaults
    sel.value = locs.includes('sv_SE') ? 'sv_SE' : (locs.includes('en_US')?'en_US':locs[0]||'en_US');
    baseSel.value = locs.includes('en_US') ? 'en_US' : (locs.includes('basic')?'basic':locs[0]||'en_US');
  }

  function updateCounts(){
    const locale = $('#localeSelect').value;
    let missing = 0;
    for (const rec of RECORDS){ if ((rec.node?.[locale]??'') === '') missing++; }
    const total = RECORDS.length;
    $('#counts').textContent = `${total} rows · ${missing} missing in ${locale}`;
  }

  // ————— Loaders —————
  function loadFromJSONObj(obj){
    LESSON = obj.lessonData || obj; // allow either wrapper or direct object
    if (!LESSON || typeof LESSON !== 'object') throw new Error('Could not find a valid object. Paste either the lesson object or {"lessonData": ...}');

    // Reset
    RECORDS = []; LOCALES = new Set();

    collectLocales(LESSON);
    RECORDS = collectTranslatables(LESSON);

    populateLocaleSelects();
    renderTable();
  }

  // ————— Buttons —————
  $('#btnLoadWindow').addEventListener('click', () => {
    if (window.lessonData){
      loadFromJSONObj(window.lessonData);
    } else if (window.lessonData === undefined && window.lessonDataRaw){
      try{ loadFromJSONObj(JSON.parse(window.lessonDataRaw)); }catch(e){ alert('window.lessonDataRaw exists but is not valid JSON'); }
    } else {
      alert('window.lessonData is not defined on this page. Paste JSON below and click "Load JSON".');
    }
  });

  $('#btnLoadTextarea').addEventListener('click', () => {
    try{
      const raw = $('#jsonInput').value.trim();
      if (!raw) { alert('Paste JSON first.'); return; }
      const obj = JSON.parse(raw);
      loadFromJSONObj(obj);
    } catch (e) {
      alert('Invalid JSON: ' + e.message);
    }
  });

  $('#btnDownload').addEventListener('click', () => {
    const ensure = $('#ensureKeys').checked;
    const locale = $('#localeSelect').value;
    if (ensure){
      for (const rec of RECORDS){ if (!(locale in rec.node)) rec.node[locale] = rec.node?.en_US ?? rec.node?.basic ?? ''; }
    }
    download('lessonData.updated.json', JSON.stringify(LESSON, null, 2));
  });

  $('#btnCSV').addEventListener('click', () => {
    const rows = JSON.parse(grid.dataset.csv || '[]');
    if (!rows.length){ alert('Nothing to export. Load JSON first.'); return; }
    downloadCSV('lesson_strings.csv', rows);
  });

  // ————— Interactions —————
  $('#localeSelect').addEventListener('change', renderTable);
  $('#baseSelect').addEventListener('change', renderTable);
  $('#missingOnly').addEventListener('change', renderTable);
  $('#search').addEventListener('input', () => { renderTable(); });

  // ————— Demo seed (optional) —————
  // If you want this file to open with a tiny demo, you can assign window.lessonDataRaw to a JSON string externally
})();
</script>
</body>
</html>
