<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lesson JSON Translation Editor</title>
<style>
  :root{--brand:#0a1f44;--muted:#6b7280;--ok:#16a34a;--warn:#e11d48;--line:#e5e7eb}
  html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f8fc;color:#0f172a}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:14px 18px;z-index:10}
  header h1{margin:0;font-size:18px;color:var(--brand)}
  header .sub{font-size:13px;color:var(--muted)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toolbar{margin:12px 0}
  select,input[type=text],input[type=password],textarea,button{
    border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font:inherit
  }
  textarea#jsonInput{width:100%;min-height:160px;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  button{cursor:pointer}
  button.primary{background:var(--brand);border-color:transparent;color:#fff}
  button.ghost{background:#fff}
  label.chk{display:flex;gap:6px;align-items:center;font-size:13px;color:#334155}
  details.box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0}
  details.box summary{cursor:pointer;font-weight:600}
  .status{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  thead th{position:sticky;top:64px;background:#f9fafb;border-bottom:1px solid var(--line);font-size:12px;text-transform:uppercase;letter-spacing:.03em;color:#334155;padding:8px}
  tbody td{border-bottom:1px solid var(--line);vertical-align:top;padding:8px}
  tbody tr:nth-child(odd){background:#fcfdff}
  .path{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:nowrap;max-width:360px;overflow:hidden;text-overflow:ellipsis}
  .base,.loc{min-width:260px}
  textarea.edit{width:100%;min-height:62px;resize:vertical}
  .len{font-size:12px;color:#475569}
  .missing{color:var(--warn);font-weight:600}
  .ok{color:var(--ok);font-weight:600}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <h1>Lesson JSON Translation Editor</h1>
  <div class="sub">Paste your JSON or connect to GitHub. Only edits <code>questions[i].title/text/explanationText/rightAnswerText/wrongAnswerText</code>.</div>
</header>

<div class="container">
  <!-- Load / Paste -->
  <details class="box" open>
    <summary>Load / Paste JSON</summary>
    <div class="status">You can paste plain JSON, <code>{"lessonData": {...}}</code>, or a JS file that starts with <code>var/let/const lessonData = {...};</code></div>
    <div class="toolbar row">
      <button id="btnLoadTextarea" class="primary">Load JSON from textarea</button>
      <button id="btnDownload" class="ghost">Export updated JSON</button>
      <button id="btnCSV" class="ghost">Export CSV (visible rows)</button>
      <label class="chk"><input type="checkbox" id="exportWithWrapper"> Save with <code>var lessonData = …;</code></label>
    </div>
    <textarea id="jsonInput" placeholder='Paste lesson JSON or a JS file that defines "lessonData" here...'></textarea>
  </details>

  <!-- GitHub -->
  <details class="box" open>
    <summary>Connect to GitHub (load & save)</summary>
    <div class="row" style="gap:8px;margin:8px 0">
      <input id="ghOwner" placeholder="owner (e.g. johanpantzare)" style="min-width:220px">
      <input id="ghRepo"  placeholder="repo (e.g. video-course)" style="min-width:220px">
      <input id="ghBranch" placeholder="branch (default: main)" style="min-width:160px">
      <input id="ghPath"   placeholder="path (e.g. translation.json)" style="min-width:260px">
      <input id="ghToken"  placeholder="token (classic PAT)" type="password" style="min-width:300px">
      <label class="chk"><input type="checkbox" id="ghRemember"> Remember on this device</label>
    </div>
    <div class="row toolbar">
      <input id="ghMessage" placeholder="Commit message (default: Update lesson translations)" style="flex:1;min-width:260px">
      <span class="right"></span>
      <button id="btnGHLoad" class="ghost">Load from GitHub</button>
      <button id="btnGHSave" class="primary">Save to GitHub</button>
    </div>
    <div class="status" id="ghStatus">—</div>
  </details>

  <!-- Controls -->
  <div class="row toolbar">
    <label>Locale
      <select id="localeSelect"></select>
    </label>
    <label>Base (comparison)
      <select id="baseSelect"></select>
    </label>
    <input id="search" type="text" placeholder="Search in path or text…" style="min-width:280px">
    <label class="chk"><input type="checkbox" id="missingOnly"> Show missing/empty only</label>
    <label class="chk"><input type="checkbox" id="ensureKeys"> Ensure keys exist for selected locale on export/save</label>
    <span id="counts" class="pill">—</span>
  </div>

  <!-- Grid -->
  <table id="grid" hidden>
    <thead>
      <tr>
        <th style="width:36px">#</th>
        <th>Path</th>
        <th>Base</th>
        <th>Locale</th>
        <th style="width:110px">Len</th>
        <th style="width:100px">Status</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="status" id="footerCounts">—</div>
</div>

<script>
(() => {
  // ===== Helpers =====
  const $ = (s, r=document) => r.querySelector(s);
  const tbody = $('#tbody'), grid = $('#grid');

  const isLocaleKey = k => k === 'basic' || /^[a-z]{2}_[A-Z]{2}$/.test(k);
  const download = (name, text, type='application/json') => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type}));
    a.download = name; document.body.appendChild(a); a.click(); a.remove();
  };
  const toB64 = (s) => btoa(unescape(encodeURIComponent(s)));
  const fromB64 = (b) => decodeURIComponent(escape(atob(b)));

  // ===== State =====
  let LESSON = null;        // Parsed lesson object
  let RECORDS = [];         // [{ path, node, baseLocale }]
  let LOCALES = new Set();
  const GITHUB = { owner:'', repo:'', branch:'main', path:'translation.json', token:'', sha:'' };
  let WRAPPER = { has:false, before:'', after:'' }; // for var lessonData wrapper

  // ===== Parse incoming text that may have a JS wrapper =====
  function extractLessonFromText(text){
    const t = text.trim();
    // Case A: plain JSON { ... } or {"lessonData": {...}}
    if (t.startsWith('{')) {
      const obj = JSON.parse(t);
      return { lesson: obj.lessonData || obj, wrapper:{has:false,before:'',after:''} };
    }
    // Case B: JS assignment: var/let/const lessonData = { ... };
    const assignIdx = t.search(/\b(?:var|let|const)\s+lessonData\s*=/);
    if (assignIdx === -1) throw new Error('Not valid JSON and no "lessonData" assignment found.');
    const braceStart = t.indexOf('{', assignIdx);
    if (braceStart === -1) throw new Error('Could not find opening { after lessonData =');
    // Bracket-match to find the closing }
    let i = braceStart, depth = 0, inStr = false, strCh = '', esc = false;
    for (; i < t.length; i++){
      const ch = t[i];
      if (inStr){
        if (esc){ esc = false; }
        else if (ch === '\\\\'){ esc = true; }
        else if (ch === strCh){ inStr = false; strCh = ''; }
      } else {
        if (ch === '"' || ch === "'"){ inStr = true; strCh = ch; }
        else if (ch === '{'){ depth++; }
        else if (ch === '}'){ depth--; if (depth === 0) { i++; break; } }
      }
    }
    if (depth !== 0) throw new Error('Unbalanced braces in file.');
    const jsonText = t.slice(braceStart, i);
    const before = t.slice(0, braceStart);
    const after  = t.slice(i).replace(/^[\\s;]*/, ''); // strip optional semicolon/newlines
    const obj = JSON.parse(jsonText);
    return { lesson: obj, wrapper:{has:true,before,after} };
  }

  // ===== Collect locales & records (only requested fields) =====
  function collectLocales(obj){
    (obj.languages || []).forEach(x => x?.locale && LOCALES.add(x.locale));
    // Also derive from objects that look like translation maps
    const visit = (node) => {
      if (node && typeof node === 'object' && !Array.isArray(node)){
        const keys = Object.keys(node);
        if (keys.some(isLocaleKey)) keys.filter(isLocaleKey).forEach(k => LOCALES.add(k));
        Object.values(node).forEach(visit);
      } else if (Array.isArray(node)) node.forEach(visit);
    };
    visit(obj);
  }

  function collectRecords(obj){
    const FIELDS = ['title','text','explanationText','rightAnswerText','wrongAnswerText'];
    const questions = Array.isArray(obj.questions) ? obj.questions
                     : (obj.lessonData && Array.isArray(obj.lessonData.questions)) ? obj.lessonData.questions
                     : [];
    const recs = [];
    questions.forEach((q, i) => {
      FIELDS.forEach(field => {
        const node = q?.[field];
        if (node && typeof node === 'object' && !Array.isArray(node)){
          const keys = Object.keys(node);
          if (keys.some(isLocaleKey)){
            const locs = keys.filter(isLocaleKey);
            const baseLocale = locs.includes('en_US') ? 'en_US' : (locs.includes('basic') ? 'basic' : locs[0]);
            recs.push({ path:`questions[${i}].${field}`, node, baseLocale });
          }
        }
      });
    });
    return recs;
  }

  // ===== UI population =====
  function populateLocaleSelects(){
    const locs = Array.from(LOCALES).sort();
    const localeSel = $('#localeSelect'), baseSel = $('#baseSelect');
    localeSel.innerHTML = ''; baseSel.innerHTML = '';
    for (const l of locs){
      const a = document.createElement('option'); a.value = l; a.textContent = l; localeSel.appendChild(a);
      const b = document.createElement('option'); b.value = l; b.textContent = l; baseSel.appendChild(b);
    }
    localeSel.value = locs.includes('sv_SE') ? 'sv_SE' : (locs.includes('en_US') ? 'en_US' : locs[0] || 'en_US');
    baseSel.value   = locs.includes('en_US') ? 'en_US' : (locs.includes('basic') ? 'basic' : locs[0] || 'en_US');
  }

  function renderTable(){
    const locale = $('#localeSelect').value;
    const base = $('#baseSelect').value;
    const q = $('#search').value.trim().toLowerCase();
    const missingOnly = $('#missingOnly').checked;

    tbody.innerHTML = '';
    let shown = 0, missing = 0, idx = 0;
    const csvRows = [];

    for (const rec of RECORDS){
      idx++;
      const baseText = rec.node?.[base] ?? '';
      const locText  = rec.node?.[locale] ?? '';
      const isMissing = (locText ?? '') === '';
      if (isMissing) missing++;

      const hay = (rec.path + ' ' + baseText + ' ' + locText).toLowerCase();
      if (q && !hay.includes(q)) continue;
      if (missingOnly && !isMissing) continue;

      shown++;
      const tr = document.createElement('tr');

      const tdIdx = document.createElement('td'); tdIdx.textContent = String(idx); tr.appendChild(tdIdx);
      const tdPath = document.createElement('td'); tdPath.className = 'path'; tdPath.title = rec.path; tdPath.textContent = rec.path; tr.appendChild(tdPath);

      const tdBase = document.createElement('td'); tdBase.className = 'base';
      const baseDiv = document.createElement('div'); baseDiv.textContent = baseText; tdBase.appendChild(baseDiv);
      tr.appendChild(tdBase);

      const tdLoc = document.createElement('td'); tdLoc.className = 'loc';
      const ta = document.createElement('textarea'); ta.className = 'edit'; ta.value = locText ?? '';
      ta.addEventListener('input', (e) => { rec.node[locale] = e.target.value; updateCounts(); });
      tdLoc.appendChild(ta); tr.appendChild(tdLoc);

      const tdLen = document.createElement('td'); tdLen.innerHTML = '<span class="len">'+(ta.value||'').length+'</span>'; tr.appendChild(tdLen);
      ta.addEventListener('input', () => tdLen.innerHTML = '<span class="len">'+(ta.value||'').length+'</span>');

      const tdStatus = document.createElement('td');
      tdStatus.innerHTML = isMissing ? '<span class="missing">Missing</span>' : '<span class="ok">OK</span>';
      ta.addEventListener('input', () => tdStatus.innerHTML = (ta.value.trim()==='')?'<span class="missing">Missing</span>':'<span class="ok">OK</span>');
      tr.appendChild(tdStatus);

      tbody.appendChild(tr);
      csvRows.push({ idx, path:rec.path, baseLocale:base, base:baseText, locale, value:ta.value });
    }

    grid.hidden = false;
    $('#counts').textContent = `${shown} rows · ${missing} missing`;
    $('#footerCounts').textContent = `${RECORDS.length} total bundles · showing ${shown}`;
    grid.dataset.csv = JSON.stringify(csvRows);
  }

  function updateCounts(){
    const locale = $('#localeSelect').value;
    const total = RECORDS.length;
    let missing = 0;
    for (const rec of RECORDS) if ((rec.node?.[locale] ?? '') === '') missing++;
    $('#counts').textContent = `${total} rows · ${missing} missing in ${locale}`;
  }

  // ===== Load a lesson object and build UI =====
  function loadFromLessonObject(obj){
    LESSON = obj.lessonData || obj;
    if (!LESSON || typeof LESSON !== 'object') throw new Error('Could not find lesson object (expected object or {"lessonData": ...}).');
    LOCALES = new Set(); RECORDS = [];
    collectLocales(LESSON);
    RECORDS = collectRecords(LESSON);
    if (!RECORDS.length) console.warn('No translatable fields found in questions[].');
    populateLocaleSelects();
    renderTable();
  }

  // ===== Button handlers: paste/load/export =====
  $('#btnLoadTextarea').addEventListener('click', () => {
    const raw = $('#jsonInput').value.trim();
    if (!raw) { alert('Paste JSON or JS first.'); return; }
    try {
      const {lesson, wrapper} = extractLessonFromText(raw);
      WRAPPER = wrapper;
      loadFromLessonObject(lesson);
    } catch (e) {
      alert('Load failed: ' + e.message);
    }
  });

  $('#btnDownload').addEventListener('click', () => {
    if (!LESSON) { alert('Nothing to export. Load JSON first.'); return; }
    if ($('#ensureKeys').checked){
      const loc = $('#localeSelect').value;
      for (const rec of RECORDS){ if (!(loc in rec.node)) rec.node[loc] = rec.node.en_US ?? rec.node.basic ?? ''; }
    }
    const json = JSON.stringify(LESSON, null, 2);
    if ($('#exportWithWrapper').checked || WRAPPER.has){
      // Rebuild a friendly wrapper regardless of original before/after
      const wrapped = 'var lessonData = ' + json + ';\n';
      download('translation.wrapped.js', wrapped, 'text/javascript');
    } else {
      download('lessonData.updated.json', json);
    }
  });

  $('#btnCSV').addEventListener('click', () => {
    const rows = JSON.parse(grid.dataset.csv || '[]');
    if (!rows.length){ alert('Nothing to export.'); return; }
    const esc = s => '"' + String(s ?? '').replaceAll('"','""') + '"';
    const header = ['#','path','baseLocale','base','locale','value'].map(esc).join(',');
    const csv = [header, ...rows.map(r => [r.idx,r.path,r.baseLocale,r.base,r.locale,r.value].map(esc).join(','))].join('\n');
    download('lesson_strings.csv', csv, 'text/csv');
  });

  // ===== Interactions =====
  $('#localeSelect').addEventListener('change', renderTable);
  $('#baseSelect').addEventListener('change', renderTable);
  $('#missingOnly').addEventListener('change', renderTable);
  $('#search').addEventListener('input', renderTable);

  // ===== GitHub integration =====
  const ghStatus = (msg) => $('#ghStatus').textContent = msg || '—';

  function ghReadInputs(){
    GITHUB.owner = $('#ghOwner').value.trim();
    GITHUB.repo  = $('#ghRepo').value.trim();
    GITHUB.branch= $('#ghBranch').value.trim() || 'main';
    GITHUB.path  = $('#ghPath').value.trim() || 'translation.json';
    GITHUB.token = $('#ghToken').value.trim();
  }
  function ghWriteInputs(){
    $('#ghOwner').value = GITHUB.owner;
    $('#ghRepo').value  = GITHUB.repo;
    $('#ghBranch').value= GITHUB.branch || '';
    $('#ghPath').value  = GITHUB.path || 'translation.json';
    $('#ghToken').value = GITHUB.token;
  }
  function ghLoadLocal(){
    try{
      const saved = JSON.parse(localStorage.getItem('jsonEditor.gh') || '{}');
      Object.assign(GITHUB, saved);
      ghWriteInputs();
      if (saved.token) $('#ghRemember').checked = true;
    }catch{}
  }
  function ghPersistLocal(){
    const remember = $('#ghRemember').checked;
    const {owner,repo,branch,path,token} = GITHUB;
    localStorage.setItem('jsonEditor.gh', JSON.stringify({owner,repo,branch,path, token: remember?token:''}));
  }

  async function githubLoad(){
    ghReadInputs(); ghPersistLocal(); ghStatus('Loading from GitHub…');
    if (!GITHUB.owner || !GITHUB.repo || !GITHUB.path){ ghStatus('Owner, repo, and path are required.'); return; }
    const url = `https://api.github.com/repos/${encodeURIComponent(GITHUB.owner)}/${encodeURIComponent(GITHUB.repo)}/contents/${GITHUB.path}?ref=${encodeURIComponent(GITHUB.branch||'main')}`;
    const headers = {};
    if (GITHUB.token) headers.Authorization = `token ${GITHUB.token}`;
    const res = await fetch(url, { headers });
    if (!res.ok){ ghStatus(`Error ${res.status}: ${res.statusText}`); return; }
    const data = await res.json();
    if (!data.content){ ghStatus('No content in response.'); return; }
    GITHUB.sha = data.sha || '';
    const text = fromB64(data.content);
    $('#jsonInput').value = text;
    try {
      const {lesson, wrapper} = extractLessonFromText(text);
      WRAPPER = wrapper;
      loadFromLessonObject(lesson);
      ghStatus('Loaded ✔');
    } catch (e) {
      ghStatus('Fetched, but parse failed: ' + e.message);
    }
  }

  async function githubSave(){
  ghReadInputs(); ghPersistLocal(); ghStatus('Saving to GitHub…');
  if (!LESSON){ ghStatus('Load JSON first.'); return; }
  if (!GITHUB.owner || !GITHUB.repo || !GITHUB.path){ ghStatus('Owner, repo, and path are required.'); return; }

  // Ensure target-locale keys if requested
  if (document.getElementById('ensureKeys').checked){
    const loc = document.getElementById('localeSelect').value;
    for (const rec of RECORDS){ if (!(loc in rec.node)) rec.node[loc] = rec.node.en_US ?? rec.node.basic ?? ''; }
  }

  const json = JSON.stringify(LESSON, null, 2);
  const contentText = (document.getElementById('exportWithWrapper').checked || WRAPPER.has)
    ? ('var lessonData = ' + json + ';\n')
    : json;

  const headers = {
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version': '2022-11-28',
    'Content-Type': 'application/json',
    ...(GITHUB.token ? { Authorization: `token ${GITHUB.token}` } : {})
  };

  // Helper: get latest sha (and existence) for the file
  async function fetchSha(){
    const url = `https://api.github.com/repos/${encodeURIComponent(GITHUB.owner)}/${encodeURIComponent(GITHUB.repo)}/contents/${GITHUB.path}?ref=${encodeURIComponent(GITHUB.branch||'main')}`;
    const res = await fetch(url, { headers });
    if (res.status === 404) return ''; // new file
    if (!res.ok){
      const t = await res.text().catch(()=>'');
      throw new Error(`Pre-save sha fetch failed (${res.status}): ${t || res.statusText}`);
    }
    const data = await res.json();
    return data.sha || '';
  }

  async function putOnce(sha){
    const body = {
      message: (document.getElementById('ghMessage').value || 'Update lesson translations').trim(),
      content: btoa(unescape(encodeURIComponent(contentText))), // toB64 without Unicode bugginess
      branch: GITHUB.branch || 'main',
      ...(sha ? { sha } : {})
    };
    const url = `https://api.github.com/repos/${encodeURIComponent(GITHUB.owner)}/${encodeURIComponent(GITHUB.repo)}/contents/${GITHUB.path}`;
    const res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify(body) });
    if (!res.ok){
      const errTxt = await res.text().catch(()=> '');
      const msg = (() => {
        try{ return JSON.parse(errTxt).message || errTxt || res.statusText; }catch{ return errTxt || res.statusText; }
      })();
      // Surface common causes with hints
      if (res.status === 401) throw new Error(`401 Unauthorized: token missing/invalid or lacks scope (public_repo/repo). ${msg}`);
      if (res.status === 403) throw new Error(`403 Forbidden: branch protection or insufficient token scope. ${msg}`);
      if (res.status === 409) throw new Error(`409 Conflict: sha out-of-date. ${msg}`);
      throw new Error(`${res.status} ${res.statusText}: ${msg}`);
    }
    return res.json();
  }

  try{
    // Always refresh sha before writing
    const latestSha = await fetchSha();
    try{
      const out = await putOnce(latestSha);
      GITHUB.sha = out?.content?.sha || latestSha;
      ghStatus('Saved ✔');
    } catch (e){
      // If conflict, refetch sha and retry once
      if (String(e.message).includes('409')){
        const freshSha = await fetchSha();
        const out = await putOnce(freshSha);
        GITHUB.sha = out?.content?.sha || freshSha;
        ghStatus('Saved after retry ✔');
      } else {
        ghStatus('Save failed: ' + e.message);
      }
    }
  } catch (e){
    ghStatus('Save error: ' + e.message);
  }
}


  $('#btnGHLoad').addEventListener('click', () => { githubLoad().catch(e => ghStatus('Load error: '+e.message)); });
  $('#btnGHSave').addEventListener('click', () => { githubSave().catch(e => ghStatus('Save error: '+e.message)); });

  ghLoadLocal();
})();
</script>
</body>
</html>
