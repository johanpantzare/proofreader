<!doctype html>
<meta charset="utf-8" />
<title>GitHub Save — translation.json</title>

<!-- Visible UI (token + Save + status). Nothing else is shown. -->
<label for="pat" style="display:block;margin:8px 0 4px;">Personal Access Token</label>
<input id="pat" type="password" placeholder="github_pat_xxx or ghp_xxx" style="width:420px;max-width:100%;" />
<button id="saveBtn" style="margin-left:8px;">Save to GitHub</button>
<div id="status" style="margin-top:10px;font-family:sans-serif;white-space:pre-wrap;"></div>

<script>
/* ===== Fixed target (hidden from UI) ===== */
const GH_OWNER  = 'johanpantzare';
const GH_REPO   = 'video-course';
const GH_BRANCH = 'master';
const GH_PATH   = 'translation.json';

/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $('status').textContent = msg; }
function appendStatus(msg){ $('status').textContent += ( $('status').textContent ? '\n' : '' ) + msg; }
function toB64(str){ return btoa(unescape(encodeURIComponent(str))); }
function prettyBytes(n){ return Intl.NumberFormat(undefined,{notation:'compact'}).format(n) + 'B'; }

/* Expose a programmatic injection hook without extra UI */
window.injectLesson = function(obj){
  if (!obj || typeof obj !== 'object') { setStatus('injectLesson: provide a JSON object.'); return; }
  window.LESSON = obj;
  setStatus('JSON loaded via injectLesson() ✔  ' + lessonSummary());
};

/* Try to adopt an existing global (no extra UI) */
(function adoptExisting(){
  if (typeof window.LESSON !== 'undefined') {
    setStatus('Detected global LESSON ✔  ' + lessonSummary());
    return;
  }
  if (typeof window.lessonData !== 'undefined') {
    window.LESSON = window.lessonData;
    setStatus('Detected global lessonData → LESSON ✔  ' + lessonSummary());
    return;
  }
  setStatus('No JSON loaded yet. Tip: paste JSON (Ctrl/Cmd+V) anywhere on this page to load it.');
})();

/* Paste-to-load (keeps UI minimal; no visible fields) */
window.addEventListener('paste', (e) => {
  const text = (e.clipboardData || window.clipboardData)?.getData('text');
  if (!text) return;
  try {
    const obj = JSON.parse(text);
    if (obj && typeof obj === 'object') {
      window.LESSON = obj;
      setStatus('JSON loaded from paste ✔  ' + lessonSummary());
    } else {
      appendStatus('\nPasted content wasn’t a JSON object.');
    }
  } catch {
    appendStatus('\nPasted content is not valid JSON.');
  }
});

/* Small summary for reassurance */
function lessonSummary(){
  try{
    const j = JSON.stringify(window.LESSON);
    const bytes = new TextEncoder().encode(j).length;
    let topKeys = [];
    if (window.LESSON && typeof window.LESSON === 'object') {
      topKeys = Object.keys(window.LESSON).slice(0,5);
    }
    return `(size ~ ${prettyBytes(bytes)}; top keys: ${topKeys.join(', ') || '—'})`;
  }catch{ return ''; }
}

function baseHeaders(authHeader) {
  return {
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version': '2022-11-28',
    'Content-Type': 'application/json',
    ...(authHeader ? { 'Authorization': authHeader } : {})
  };
}

async function fetchSha(headers){
  const url = `https://api.github.com/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${encodeURIComponent(GH_PATH)}?ref=${encodeURIComponent(GH_BRANCH)}`;
  const res = await fetch(url, { headers });
  if (res.status === 404) return ''; // new file
  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`Pre-save sha fetch failed (${res.status}): ${t || res.statusText}`);
  }
  const data = await res.json();
  return data.sha || '';
}

async function putOnce(headers, contentText, sha){
  const body = {
    message: 'Update translation.json',
    content: toB64(contentText),
    branch: GH_BRANCH,
    ...(sha ? { sha } : {})
  };
  const url = `https://api.github.com/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${encodeURIComponent(GH_PATH)}`;
  const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(body) });
  if (!res.ok){
    const errTxt = await res.text().catch(()=> '');
    let msg = errTxt || res.statusText;
    try { msg = JSON.parse(errTxt).message || msg; } catch {}
    if (res.status === 401) throw new Error(`401 Unauthorized: ${msg}`);
    if (res.status === 403) throw new Error(`403 Forbidden: ${msg}`);
    if (res.status === 404) throw new Error(`404 Not Found: Repo/branch/path not accessible with this token. ${msg}`);
    if (res.status === 409) throw new Error(`409 Conflict (SHA out-of-date): ${msg}`);
    throw new Error(`${res.status} ${res.statusText}: ${msg}`);
  }
  return res.json();
}

async function attemptSave(authHeader){
  const headers = baseHeaders(authHeader);
  const json = JSON.stringify(window.LESSON, null, 2);
  const latestSha = await fetchSha(headers);
  try{
    await putOnce(headers, json, latestSha);
    return 'Saved ✔';
  }catch(e){
    if (String(e.message).startsWith('409')) {
      const freshSha = await fetchSha(headers);
      await putOnce(headers, json, freshSha);
      return 'Saved after retry ✔';
    }
    throw e;
  }
}

async function githubSave(){
  if (typeof window.LESSON === 'undefined') {
    setStatus('Load JSON first. (Paste JSON or call window.injectLesson({...}))');
    return;
  }

  const token = ($('pat').value || '').trim();
  if (!token) {
    setStatus('Please paste your Personal Access Token.');
    return;
  }

  setStatus('Saving to GitHub… ' + lessonSummary());

  // 1) Try Bearer (fine-grained PAT)
  try {
    const ok = await attemptSave(`Bearer ${token}`);
    setStatus(ok);
    return;
  } catch (e1) {
    if (String(e1.message).includes('401')) {
      // 2) Fallback to legacy "token " (classic PAT)
      try {
        const ok2 = await attemptSave(`token ${token}`);
        setStatus(ok2 + ' (used legacy "token" auth)');
        return;
      } catch (e2) {
        setStatus('Save failed: ' + e2.message);
        return;
      }
    } else {
      setStatus('Save failed: ' + e1.message);
      return;
    }
  }
}

$('saveBtn').addEventListener('click', githubSave);
</script>
